name: Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Check"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  BUILD_PATH: "./src/presentation/web"
  NODE_VERSION: "20"
  BUN_VERSION: "latest"

jobs:
  check-success:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    outputs:
      should-deploy: ${{ steps.check.outputs.result }}
    steps:
      - name: Check if deployment should proceed
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "Manual deployment triggered"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "Check workflow completed successfully, proceeding with deployment"
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "Check workflow failed, skipping deployment"
          fi

  build:
    name: Prepare for Deployment
    runs-on: ubuntu-latest
    needs: check-success
    if: needs.check-success.outputs.should-deploy == 'true'
    steps:
      - name: Download build artifact from Check workflow
        uses: actions/download-artifact@v4
        with:
          name: build-${{ github.event.workflow_run.head_sha || github.sha }}
          path: ./dist
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          run-id: ${{ github.event.workflow_run.id || github.run_id }}

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Setup Pages
        uses: actions/configure-pages@v4
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

